#if 0
#define CMP_RATE_YMAX
#else
#define CMP_RATE_YMAX ymax = 14.41
#endif

#define CMP_RATE_DIR_CURVE(ver, patt, patt2, dir) \
  curve pattern patt {              \
   sql = SELECT standardized_name, rate FROM osdi_cmp_rate_by_directory_and_error_name \
         WHERE standardized_name = patt2 AND dirname = dir          \
	       AND version_name = ver; \
  }

#define CMP_RATE_DIR_GRP(ver, dir, dir2)   \
 group dir {          		  \
  CMP_RATE_DIR_CURVE(ver, Block, 'Block', dir2) \
  CMP_RATE_DIR_CURVE(ver, Null , 'Null' , dir2) \
  CMP_RATE_DIR_CURVE(ver, Var  , 'Var'  , dir2) \
  CMP_RATE_DIR_CURVE(ver, IsNull , 'IsNull' , dir2) \
  CMP_RATE_DIR_CURVE(ver, NullRef , 'NullRef' , dir2) \
  CMP_RATE_DIR_CURVE(ver, Range, 'Range', dir2) \
  CMP_RATE_DIR_CURVE(ver, Lock , 'Lock' , dir2) \
  CMP_RATE_DIR_CURVE(ver, Intr , 'Intr' , dir2) \
  CMP_RATE_DIR_CURVE(ver, LockIntr , 'LockIntr' , dir2) \
  CMP_RATE_DIR_CURVE(ver, Free , 'Free' , dir2) \
  CMP_RATE_DIR_CURVE(ver, Size , 'Size' , dir2) \
 }
//  CMP_RATE_DIR_CURVE(ver, INull, 'INull', dir2) \
//  CMP_RATE_DIR_CURVE(ver, Float, 'Float', dir2) \
//  CMP_RATE_DIR_CURVE(ver, Real , 'Real' , dir2) \
//  CMP_RATE_DIR_CURVE(ver, Param, 'Param', dir2) \

graph gr/cmp-rate-per-dir-4-241.jgr {
 xaxis = groups
 size = 3 1
 legend = "defaults fontsize 6

 newcurve marktype none linetype dotted color 0 0 0
 pts
 0   1
 55  1
"

footer = "
newgraph
 xaxis no_auto_hash_labels no_auto_hash_marks min 0 max 60 size 3
 yaxis no_auto_hash_labels no_auto_hash_marks min 0 max 235 size 1
legend defaults fontsize 6 x 24 y 150

newcurve marktype xbar linetype none color 0. 1. 0.  marksize 0.6  label : Block
newcurve marktype xbar linetype none color 1. 0. 1.  marksize 0.6  label : Null
newcurve marktype xbar linetype none color 0. 1. 0.5  marksize 0.6  label : Var
newcurve marktype xbar linetype none color 1. 0.69 0.  marksize 0.6  label : IsNull
newcurve marktype xbar linetype none color 1. 0. 0.  marksize 0.6  label : NullRef
newcurve marktype xbar linetype none color 0. 0. 0.  marksize 0.6  label : Range

newgraph
 xaxis no_auto_hash_labels no_auto_hash_marks min 0 max 60 size 3
 yaxis no_auto_hash_labels no_auto_hash_marks min 0 max 235 size 1
legend defaults fontsize 6 x 38 y 150

newcurve marktype xbar linetype none color 0.5 0. 1.  marksize 0.6  label : Lock
newcurve marktype xbar linetype none color 0. 0.5 1.  marksize 0.6  label : Intr
newcurve marktype xbar linetype none color 0.5 0.5 1.  marksize 0.6  label : LockIntr
newcurve marktype xbar linetype none color 0.5 0. 0.  marksize 0.6  label : Free
newcurve marktype xbar linetype none color 0. 1. 1.  marksize 0.6  label : Size
"

 CMP_RATE_YMAX

 CMP_RATE_DIR_GRP('linux-2.4.1', "Drivers", 'drivers')
 CMP_RATE_DIR_GRP('linux-2.4.1', "Arch"   , 'arch')
 CMP_RATE_DIR_GRP('linux-2.4.1', "FS"     , 'fs')
 CMP_RATE_DIR_GRP('linux-2.4.1', "Net"    , 'net')
 CMP_RATE_DIR_GRP('linux-2.4.1', "Other"  , 'other')
}

/*
graph gr/cmp-rate-per-dir-4-260.jgr {
 xaxis = groups
 size = 3 1
 legend = "defaults fontsize 6

 newcurve marktype none linetype dotted color 0 0 0
 pts
 0   1
 66  1
"
 CMP_RATE_YMAX

 CMP_RATE_DIR_GRP('linux-2.6.0', "Drivers", 'drivers')
 CMP_RATE_DIR_GRP('linux-2.6.0', "Sound"  , 'sound')
 CMP_RATE_DIR_GRP('linux-2.6.0', "Arch"   , 'arch')
 CMP_RATE_DIR_GRP('linux-2.6.0', "FS"     , 'fs')
 CMP_RATE_DIR_GRP('linux-2.6.0', "Net"    , 'net')
 CMP_RATE_DIR_GRP('linux-2.6.0', "Other"  , 'other')
}

graph gr/cmp-rate-per-dir-4-2612.jgr {
 xaxis = groups
 size = 3 1
 legend = "off

 newcurve marktype none linetype dotted color 0 0 0
 pts
 0   1
 66  1
"
 CMP_RATE_YMAX

 CMP_RATE_DIR_GRP('linux-2.6.12', "Drivers", 'drivers')
 CMP_RATE_DIR_GRP('linux-2.6.12', "Sound"  , 'sound')
 CMP_RATE_DIR_GRP('linux-2.6.12', "Arch"   , 'arch')
 CMP_RATE_DIR_GRP('linux-2.6.12', "FS"     , 'fs')
 CMP_RATE_DIR_GRP('linux-2.6.12', "Net"    , 'net')
 CMP_RATE_DIR_GRP('linux-2.6.12', "Other"  , 'other')
}

graph gr/cmp-rate-per-dir-4-2633.jgr {
 xaxis = groups
 size = 3 1
 legend = "off

 newcurve marktype none linetype dotted color 0 0 0
 pts
 0   1
 77  1
"
 CMP_RATE_YMAX

 CMP_RATE_DIR_GRP('linux-2.6.33', "Staging", 'staging')
 CMP_RATE_DIR_GRP('linux-2.6.33', "Drivers", 'drivers')
 CMP_RATE_DIR_GRP('linux-2.6.33', "Sound"  , 'sound')
 CMP_RATE_DIR_GRP('linux-2.6.33', "Arch"   , 'arch')
 CMP_RATE_DIR_GRP('linux-2.6.33', "FS"     , 'fs')
 CMP_RATE_DIR_GRP('linux-2.6.33', "Net"    , 'net')
 CMP_RATE_DIR_GRP('linux-2.6.33', "Other"  , 'other')
}
*/

#define CMP_RATE_DIR_EVOL(patt, dir) \
  curve pattern patt {                                              \
   sql = SELECT v.version_name,					    \
       	 	v.release_date,					    \
		(reps_dir::float / notes_dir::float)		    \
		/ (reps_other::float / notes_other::float) AS rate  \
	FROM versions v,					    \
               (SELECT rd.version_name,				    \
                  sum(rd.number_of_reports) AS reps_dir,	    \
                  sum(rd.number_of_notes)   AS notes_dir	    \
               FROM  rates rd					    \
               WHERE rd.osdi_dirname = 'drivers'		    \
               AND rd.version_name = 'linux-2.4.1'		    \
	       GROUP BY  rd.version_name) AS rd,		    \
               (SELECT ro.version_name,				    \
                  sum(ro.number_of_reports) AS reps_other,	    \
                  sum(ro.number_of_notes) AS notes_other	    \
               FROM  rates ro					    \
               WHERE ro.osdi_dirname != 'drivers'		    \
               AND ro.version_name = 'linux-2.4.1'		    \
	       GROUP BY  ro.version_name) AS ro			    \
    WHERE v.version_name = rd.version_name			    \
    AND v.version_name = ro.version_name			    \
    AND v.version_name = 'linux-2.4.1'				    \
    ORDER BY v.release_date;                                        \
  }

graph gr/cmp-rate-per-dir.jgr {
 xaxis = groups
 size = 3 1
 legend = "off

 newcurve marktype none linetype dotted color 0 0 0
 pts  0     1           2407  1
"
 CMP_RATE_YMAX

 CMP_RATE_DIR_EVOL(Staging, 'staging')
 CMP_RATE_DIR_EVOL(Drivers, 'drivers')
 CMP_RATE_DIR_EVOL(Sound  , 'sound')
 CMP_RATE_DIR_EVOL(Arch   , 'arch')
 CMP_RATE_DIR_EVOL(FS     , 'fs')
 CMP_RATE_DIR_EVOL(Net    , 'net')
 CMP_RATE_DIR_EVOL(Other  , 'other')
}
